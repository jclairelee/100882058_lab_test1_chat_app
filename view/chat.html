<!doctype html>
<html>
  <head>
    <title>Chat Room</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
  </head>
  <body class="container mt-4">
    <h2>Chat App</h2>

    <!-- Room Selection -->
    <div id="roomSelection">
      <label>Select Room:</label>
      <select id="roomSelect" class="form-select mb-2">
        <option value="Full Stack">Full Stack</option>
        <option value="Machine Learning">Machine Learning</option>
        <option value="Capstone">Capstone</option>
        <option value="Mobile App">Mobile App</option>
        <option value="Cyber Security">Cyber Security</option>
      </select>

      <button id="joinRoomBtn" class="btn btn-primary">Join Room</button>
    </div>

    <!-- Chat Area -->
    <div id="chatArea" style="display: none">
      <div class="d-flex justify-content-between">
        <h4 id="roomTitle"></h4>
        <button id="leaveRoomBtn" class="btn btn-danger btn-sm">
          Leave Room
        </button>
      </div>

      <div
        id="messages"
        class="border p-3 mb-2"
        style="height: 300px; overflow-y: auto"
      ></div>

      <input
        type="text"
        id="messageInput"
        class="form-control mb-2"
        placeholder="Type message..."
      />

      <button id="sendBtn" class="btn btn-success">Send</button>
    </div>

    <button id="logoutBtn" class="btn btn-secondary mt-3">Logout</button>

    <script src="/socket.io/socket.io.js"></script>

    <script>
      // Connect to same server (important)
      const socket = io();

      const user = JSON.parse(localStorage.getItem("chatUser"));

      // Redirect if not logged in
      if (!user) {
        window.location.href = "login.html";
      }

      let currentRoom = null;

      // JOIN ROOM
      document
        .getElementById("joinRoomBtn")
        .addEventListener("click", async () => {
          const room = document.getElementById("roomSelect").value;
          currentRoom = room;

          // Clear previous messages
          document.getElementById("messages").innerHTML = "";

          // Fetch old messages from MongoDB
          const res = await fetch(`/api/messages/group/${room}`);
          const oldMessages = await res.json();

          oldMessages.forEach((msg) => {
            const msgDiv = document.createElement("div");
            msgDiv.innerHTML = `<strong>${msg.from_user}:</strong> ${msg.message}`;
            document.getElementById("messages").appendChild(msgDiv);
          });

          socket.emit("joinRoom", { username: user.username, room });

          document.getElementById("roomTitle").innerText = "Room: " + room;
          document.getElementById("roomSelection").style.display = "none";
          document.getElementById("chatArea").style.display = "block";
        });

      // LEAVE ROOM
      document.getElementById("leaveRoomBtn").addEventListener("click", () => {
        socket.emit("leaveRoom", {
          username: user.username,
          room: currentRoom,
        });

        document.getElementById("chatArea").style.display = "none";
        document.getElementById("roomSelection").style.display = "block";
        document.getElementById("messages").innerHTML = "";

        currentRoom = null;
      });

      // SEND MESSAGE
      document.getElementById("sendBtn").addEventListener("click", () => {
        const messageInput = document.getElementById("messageInput");
        const msg = messageInput.value;

        if (!msg || !currentRoom) return;

        socket.emit("groupMessage", {
          room: currentRoom,
          from_user: user.username,
          message: msg,
        });

        messageInput.value = "";
      });

      // RECEIVE MESSAGE
      socket.on("groupMessage", (data) => {
        const msgDiv = document.createElement("div");
        msgDiv.innerHTML = `<strong>${data.from_user}:</strong> ${data.message}`;

        const messages = document.getElementById("messages");
        messages.appendChild(msgDiv);
        messages.scrollTop = messages.scrollHeight;
      });

      // LOGOUT
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("chatUser");
        window.location.href = "login.html";
      });
    </script>
  </body>
</html>
